<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzxK-9nl29lbEjStG7WtQCK2yHyn5k_IqnR3Jv6ZtemKY0SoFsnzFoTa4qiST6o1JwNig/exec";
const TOKEN = "Rf2024XimacPesca9381";
const TOTAL_NUMEROS = 100;

// ðŸ”¹ Lista local com status de pagamento
let listaPagamentos = [];

async function carregarDados() {
  const resp = await fetch(`${SCRIPT_URL}?token=${TOKEN}`);
  const json = await resp.json();
  if (!json.success) {
    alert('Erro ao carregar dados!');
    return;
  }

  const data = json.data;
  const tabela = document.getElementById("tabela");
  tabela.innerHTML = "";

  // MantÃ©m status de quem jÃ¡ estava verde (pago)
  const novos = [];
  data.forEach(item => {
    const pago = listaPagamentos.find(p => p.numero === item.numero)?.pago || false;
    novos.push({ ...item, pago });

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.numero}</td>
      <td>${item.nome}</td>
      <td>${item.whatsapp}</td>
      <td>${item.data ? item.data : "-"}</td>
    `;
    if (pago) tr.style.background = "#c8e6c9"; // verde claro

    // Clique para marcar/desmarcar pagamento
    tr.addEventListener("click", () => {
      tr.classList.toggle("pago");
      if (tr.classList.contains("pago")) {
        tr.style.background = "#c8e6c9"; // verde claro
        atualizarStatus(item.numero, true);
      } else {
        tr.style.background = ""; // volta normal
        atualizarStatus(item.numero, false);
      }
    });

    tabela.appendChild(tr);
  });

  listaPagamentos = novos;

  // Atualiza resumo
  document.getElementById("vendidos").textContent = data.length;
  document.getElementById("disponiveis").textContent = TOTAL_NUMEROS - data.length;
  document.getElementById("participantes").textContent = new Set(data.map(d => d.nome)).size;

  // Pesquisa dinÃ¢mica
  const pesquisa = document.getElementById("pesquisa");
  pesquisa.addEventListener("input", () => {
    const termo = pesquisa.value.toLowerCase();
    document.querySelectorAll("#tabela tr").forEach(tr => {
      const texto = tr.textContent.toLowerCase();
      tr.style.display = texto.includes(termo) ? "" : "none";
    });
  });

  // Exportar CSV com todos os nÃºmeros:
  // - Pagos â†’ nome + nÃºmero
  // - NÃ£o pagos â†’ apenas nÃºmero
  document.getElementById("baixar").onclick = () => {
    let csv = "NÃºmero,Nome\n";
    listaPagamentos.forEach(item => {
      if (item.pago) {
        csv += `${item.numero},${item.nome}\n`;
      } else {
        csv += `${item.numero},\n`;
      }
    });
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "rifa_com_pagamentos.csv";
    link.click();
  };
}

// ðŸ”¹ Atualiza status local (quem pagou)
function atualizarStatus(numero, pago) {
  const i = listaPagamentos.findIndex(p => p.numero === numero);
  if (i >= 0) listaPagamentos[i].pago = pago;
}

// Atualiza automaticamente a cada 6 segundos
carregarDados();
setInterval(carregarDados, 6000);
</script>
